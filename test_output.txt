
> play-money-casino-bot@0.1.0 test
> cross-env NODE_OPTIONS=--experimental-vm-modules jest --config jest.config.mjs --runInBand tests/admin.perguild.test.ts

  console.error
    Migration 000_admin_core failed: table admin_users has no column named role

    [0m [90m 74 |[39m
     [90m 75 |[39m     [90m// Log the error for debugging[39m
    [31m[1m>[22m[39m[90m 76 |[39m     console[33m.[39merror([32m`Migration ${mig.id} failed:`[39m[33m,[39m errorMsg)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 77 |[39m     [90m// Re-throw other errors[39m
     [90m 78 |[39m     [36mthrow[39m e[33m;[39m
     [90m 79 |[39m   }[0m

      at runOne (src/db/migrate.ts:76:13)
      at runDirOnDb (src/db/migrate.ts:87:23)
      at runMigrations (src/db/migrate.ts:106:30)
      at Object.<anonymous> (tests/admin.perguild.test.ts:102:19)

(node:35816) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL tests/admin.perguild.test.ts
  per-guild admin isolation
    √ add/remove scoped to guild; list shows only current guild admins + global super (6 ms)
    × migration deletes legacy global admin rows (no leaks) (81 ms)

  ● per-guild admin isolation › migration deletes legacy global admin rows (no leaks)

    SqliteError: table admin_users has no column named role

    [0m [90m 40 |[39m         console[33m.[39mlog([33mJSON[39m[33m.[39mstringify({ msg[33m:[39m [32m'running_sql_migration'[39m[33m,[39m id[33m:[39m mig[33m.[39mid[33m,[39m sql[33m:[39m sql[33m.[39msubstring([35m0[39m[33m,[39m [35m200[39m) }))[33m;[39m
     [90m 41 |[39m       }
    [31m[1m>[22m[39m[90m 42 |[39m       db[33m.[39mexec(sql)[33m;[39m
     [90m    |[39m          [31m[1m^[22m[39m
     [90m 43 |[39m     } [36melse[39m {
     [90m 44 |[39m       [90m// JS/TS migration: must export async function up(db)[39m
     [90m 45 |[39m       [36mconst[39m mod[33m:[39m any [33m=[39m [36mawait[39m [36mimport[39m(pathToFileURL(mig[33m.[39mpath)[33m.[39mhref)[33m;[39m[0m

      at Database.exec (node_modules/better-sqlite3/lib/methods/wrappers.js:9:14)
      at runOne (src/db/migrate.ts:42:10)
      at runDirOnDb (src/db/migrate.ts:87:23)
      at runMigrations (src/db/migrate.ts:106:30)
      at Object.<anonymous> (tests/admin.perguild.test.ts:102:19)

Test Suites: 1 failed, 1 total
Tests:       1 failed, 1 passed, 2 total
Snapshots:   0 total
Time:        0.708 s, estimated 1 s
Ran all test suites matching /tests\\admin.perguild.test.ts/i.
